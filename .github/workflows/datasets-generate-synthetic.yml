name: Deploy datasets

on:
  push:
    branches: ["main"]
    paths:
      - "synthetic-datasets/synthetic_datasets/**/*.py"
      - ".github/workflows/datasets-generate-synthetic.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate:
    name: Generate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install moon
        uses: moonrepo/setup-toolchain@v0
        with:
          auto-install: false

      - name: Setup toolchains
        run: moon setup

      - name: Generate datasets
        run: |
          moon run synthetic-datasets:generate -- 1000
          moon run synthetic-datasets:generate -- 25000
          moon run synthetic-datasets:generate -- 500000

      - name: Clone HF repo and move datasets into it
        env:
          GIT_LFS_SKIP_SMUDGE: 1
        run: |
          git clone --depth 1 https://${{ vars.HF_USERNAME }}:${{ secrets.HF_TOKEN }}@huggingface.co/datasets/tracksy-app/synthetic-datasets .tmp/synthetic-datasets
          rsync -a synthetic-datasets/datasets/ .tmp/synthetic-datasets/

      - name: Commit datasets
        run: |
          cd .tmp/synthetic-datasets
          git config user.name "${{ vars.GIT_AUTHOR_NAME }}"
          git config user.email "${{ vars.GIT_AUTHOR_EMAIL }}"
          git add -f datasets/
          git commit -m "üç± add or update generated datasets"
          git push origin main
